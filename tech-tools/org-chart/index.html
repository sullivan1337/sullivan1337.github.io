<html>
  <head>
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      media="screen"
      href="https://unpkg.com/handsontable@9.0.2/dist/handsontable.full.min.css"
    />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <style>
      .floating-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 10px 15px;
        background-color: #008CBA; /* Blue */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .floating-btn:hover {
        background-color: #007B9A;
      }
      .floating-btn input[type='file'] {
        display: none;
      }
      #hot {
        position: fixed;
        bottom: 0;
        height: 15%;
        width: 100%;
        z-index: 1;
        padding-top: 10px;
        background-color: #000000;
      }
      #chart-container {
        height: 85%;
        background-color: #c5c5c5;
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <label class="floating-btn">
      Upload the org chart CSV/XLSX
      <input type="file" id="input-file" accept=".xlsx,.csv" />
    </label>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://unpkg.com/handsontable@9.0.2/dist/handsontable.full.min.js"></script>

    <div id="chart-container"></div>
    <div id="hot"></div>

    <script>
      var hot;
      var chartContainer = document.getElementById('chart-container');

      function adjustContainerHeight() {
        var windowHeight = window.innerHeight;
        var hotHeight = document.getElementById('hot').offsetHeight;
        chartContainer.style.height = windowHeight - hotHeight + 'px';
      }

      function renderChart(data) {
        // clear the chart container
        chartContainer.innerHTML = '';

        var chart = new d3.OrgChart()
          .container('#chart-container')
          .data(data)
          .nodeWidth((d) => 250)
          .initialZoom(1.2)
          .nodeHeight((d) => 175)
          .childrenMargin((d) => 40)
          .compactMarginBetween((d) => 15)
          .compactMarginPair((d) => 80)
          .nodeContent(function (d, i, arr, state) {
            return `
              <div style="padding-top:30px;background-color:none;margin-left:1px;height:${
                d.height
              }px;border-radius:2px;overflow:visible">
                <div style="height:${
                  d.height - 32
                }px;padding-top:0px;background-color:white;border:1px solid lightgray;">
                  <img src=" ${
                    d.data.imageUrl
                  }" style="margin-top:-30px;margin-left:${d.width / 2 - 30}px;border-radius:100px;width:60px;height:60px;" />
                  <div style="margin-right:10px;margin-top:15px;float:right">${
                    d.data.id
                  }</div>
                  <div style="margin-top:-30px;background-color:#3AB6E3;height:10px;width:${
                    d.width - 2
                  }px;border-radius:1px"></div>
                  <div style="padding:20px; padding-top:35px;text-align:center">
                    <div style="color:#111672;font-size:16px;font-weight:bold"> ${
                      d.data.name
                    } </div>
                    <div style="color:#404040;font-size:16px;margin-top:4px"> ${
                      d.data.positionName
                    } </div>
                  </div> 
                  <div style="display:flex;justify-content:space-between;padding-left:15px;padding-right:15px;">
                    <div > Manages:  ${d.data._directSubordinates} ðŸ‘¤</div>  
                    <div > Oversees: ${d.data._totalSubordinates} ðŸ‘¤</div>    
                  </div>
                </div>     
              </div>
              `;
          })
          .render();
      }

      window.addEventListener('resize', adjustContainerHeight);

      $(document).ready(function () {
        $('#hot').resizable({
          handles: 'n',
          minHeight: 100,
          maxHeight: window.innerHeight - 100,
          resize: function () {
            adjustContainerHeight();
          },
        });
      });

      document.getElementById('input-file').addEventListener('change', function() {
        var file = this.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
          var data;
          if (file.name.endsWith('.csv')) {
            data = d3.csvParse(e.target.result);
          } else { // .xlsx file
            var workbook = XLSX.read(e.target.result, {type: 'binary'});
            var worksheet = workbook.Sheets[workbook.SheetNames[0]];
            data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
          }

          // Initialize Handsontable instance
          hot = new Handsontable(document.getElementById('hot'), {
            data: data,
            rowHeaders: true,
            colHeaders: true,
            afterChange: function(changes, source) {
              if (source !== 'loadData') {
                var newData = hot.getData();
                renderChart(newData);
              }
            },
          });

          adjustContainerHeight();
          renderChart(data);
        };

        if(file.name.endsWith('.csv')) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      });
    </script>
  </body>
</html>
